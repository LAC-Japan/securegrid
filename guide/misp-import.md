# 概要

本資料は、MISPへのデータ投入を行うためのプログラムを開発するためのガイドになります。
本資料では、python用のMISP操作ライブラリであるpymispを使って、MISPにイベントを登録する方法について説明します。
ご不明点につきましては、以下のSecureGRIDアライアンス事務局連絡先へご連絡ください。

SecureGRIDアライアンス事務局： ＊＊＊＊


# コンテンツ

以下内容について記載します。
* MISP投入プログラムの開発方法
* 公開済みMISP投入プログラム


# MISP投入プログラムの開発方法

プログラム（以下ではpython）を使ったMISPへのイベント登録については、
[pymisp](https://github.com/MISP/PyMISP){:target="_blank"}
を利用することで容易に実現できる環境が整っています。
これにより、１時間に１回や１日１回など、定期的に情報を自動投入するというニーズを実現することが可能です。
以下では、最も一般的なパターンであると思われる、入力データが記載されたファイルを読み込み、それをMISPに登録するというユースケースについて、具体例を含めご紹介します。


## 今回のサンプルプログラム

今回は、当社が先日公開した
[ransomwatch(の記事が公開されたらそのURLにする)](https://www.lac.co.jp/lacwatch)
で収集した情報をMISPに格納するというユースケースを例に進めたいと思います。
まず、早速ですが、サンプルデータとプログラムを
[ダウンロード](../sample/misp-import.py)
してください。
こちらのzipファイルを解凍いただくと、以下二つのファイルが入っています。
* sample.csv: 今回インポート対象とするCSVファイルです。構成についてはヘッダをご参照ください。尚、社名等一部の項目については、今回はあくまでサンプルのためマスクしています。
* import-sample.py: 今回のデータをインポートするためのpythonプログラム。こちらの内容を元に以下で説明します


## 事前準備

まず、pymispをインストールします。
pipでインストール可能です。
`pip install pymisp`


## プログラムの基本構成

では早速、import-sample.pyをみて行きたいと思います。
大枠として、以下流れで処理が行われています。
* 1 ファイルから情報を読み込む
* 2 MISPイベントの単位に合わせて上記１の情報を集約する
* 3 MISPにイベント登録する

コードでいうと以下部分をご覧いただくと、全体的な流れが上記のようになっていることが確認できるかと思います
`
if __name__ == '__main__':
`

では、個別の処理の中身について順番に説明していきます。


## ファイルから情報を読み込む

read_file

## MISPイベントの単位に合わせて上記１の情報を集約する

create_misp_event

## MISPにイベント登録する

register_misp


## まとめ

今回は、入力となるファイルを元に、そのファイルを読み込みMISPにイベントとして登録するプログラムの実現方法についてご説明しました。
この入力ファイル部分を、１日１回最新の情報を格納したファイルを読み込むようにすれば毎日自動的に最新情報が投入することが可能です。
またこの入力ファイルの中身を変更し、集約する部分（今回の例でいうとcreate_misp_eventメソッド）を適に変更すれば、任意のデータをイベント登録することが可能です。
今回はCSVファイルを例にしましたが、ここはJSONファイルやアクセスログのフォーマットなどなんでも問題ありません。入力ファイルのフォーマットに合わせて一般的なpythonプログラムで行うようにファイルパースを行うことで、様々な入力データに対応が可能です。
ぜひ今回の例を参考に、ご自身の手元にあるデータをMISPに投入してみてください。
不明点や思った通りに動かないなど何かございましたら、お気軽にアライアンス事務局までご連絡ください。

# (参考)公開済みのMISP投入プログラム
[手動作成CSVのMISP投入](https://github.com/LAC-Japan/MISP-CSVImport){:target="_blank"}
[AnyrunデータのMISP投入](https://github.com/LAC-Japan/anyrun_to_misp){:target="_blank"}
